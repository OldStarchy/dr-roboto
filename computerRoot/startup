if (_G.osStarted == true) then
	suppressMissingGlobalWarnings(false)

	print('Running startup tests')
	shell.run('less run test')

	ItemInfo.DefaultItemInfo = ItemInfo()
	ItemInfo.DefaultItemInfo:loadHardTable('item.dictionary')
	return
end

_G.osStarted = true

if (os.version == nil) then
	dofile 'bootstrap.lua'
	loadfile('test.lua')(1)
	return
end

term.clear()
term.setCursorPos(1, 1)

if (settings ~= nil) then
	if (multishell ~= nil) then
		settings.set('bios.use_multishell', false)
		settings.save('.settings')
		os.reboot()
	end
end

local osshutdown = os.shutdown
local osrun = os.run

os.shutdown = function()
	os.shutdown = osshutdown
	os.run = osrun

	local ok, err =
		pcall(
		function()
			dofile 'bootstrap.lua'

			dofile 'os.lua'
		end
	)

	-- If the shell errored, let the user read it.
	term.redirect(term.native())
	if not ok then
		printError(err)
		printStackTrace(4)
		pcall(
			function()
				term.setCursorBlink(false)
				print('Press any key to continue')
				os.pullEvent('key')
			end
		)
	end

	os.shutdown()
end

os.run = function(...)
end

shell.exit()
