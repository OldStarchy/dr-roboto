-- Please do not edit this file

-- This file is run by the CraftOS shell. It is the earliest point at which we can execute code.

-- Disable multishell
if (settings ~= nil) then
	if (multishell ~= nil) then
		settings.set('bios.use_multishell', false)
		settings.save('.settings')
		os.reboot()
	end
end

-- Redefine loadfile to include an env paramter
_G.loadfile = function(_sFile, _tEnv)
	local file = fs.open(_sFile, 'r')
	if file then
		local func, err = loadstring(file.readAll(), _sFile)
		file.close()
		if (type(_tEnv) == 'table') then
			setfenv(func, _tEnv)
		end
		return func, err
	end
	return nil, 'File not found'
end

local isPc = false
if (os.version == nil) then
	isPc = true
end

if (isPc) then
	print('Running on PC - loading polyfills')
	dofile '../_polyfills/_main.lua'

	lfs.chdir('computerRoot')
	dofile 'roboto/os.lua'
end

local drRobotoIsLoaded = os.version and os.version():sub(1, 10) == 'Dr. Roboto'

if (not drRobotoIsLoaded) then
	local osshutdown = os.shutdown
	local osrun = os.run

	local file = fs.open('roboto/os.lua', 'r')
	local oschunk, err

	if file then
		oschunk, err = load(file.readAll(), 'roboto/os.lua', 't', getfenv(osshutdown))
		file.close()
	else
		error('Could not find Roboto OS')
	end

	if (oschunk == nil) then
		error('Could not load Roboto OS: ' .. err)
	end

	--os.shutdown will be called after the shell exits below
	os.shutdown = function()
		os.shutdown = osshutdown
		os.run = osrun

		local success, err = pcall(oschunk)
		xpcall(
			function()
				if (not success) then
					term.redirect(term.native())
					term.setBackgroundColour(colours.black)

					if (term.isColour()) then
						term.setTextColour(colours.red)
					end

					print(err)

					term.setTextColour(colours.white)
					print('Press any key to continue...')

					os.pullEvent('key')
				end
			end,
			function(err)
				print(err)
				print('Press any key to continue...')
				os.pullEvent('key')
			end
		)

		os.shutdown()
	end

	os.run = function(...)
	end

	shell.exit()
end
